---
title: "Implementando ICs"
author: "Nazareno"
output:
  html_document:
    theme: readable
    df_print: paged
    toc: yes
  html_notebook:
    fig_width: 7
    theme: readable
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
theme_set(theme_bw())
```

## Os dados

```{r}
set.seed(12345)

lastfm = read_csv(here::here("data/experimento-lastfm.csv"), 
                  col_types = cols(.default = col_double(), 
                                   user = col_character()))

lastfm = lastfm %>% 
  sample_n(300) %>% 
  select(news, old, mediana_pop)

glimpse(lastfm)
```

## Proporção de artistas novos e popularidade

Utilizaremos ICs para estimar duas métricas sobre os usuários do LastFM em geral durante um período de 6 meses. Em ambos os casos faremos isso a partir de uma amostra de 300 usuários. As duas métricas são: 

1. Qual a proporção de novos artistas em geral escutada por usuários?
2. Para os usuários que gostam de música muito pop (mediana_pop > 5), qual a correlação entre a popularidade mediana dos artistas escutado e a proporção dos artistas escutados que eram novos. 

Crie intervalos com 95% de confiança.


```{r}
library(boot)
library(broom)

theta <- function(d, i) {
    df = d %>%
        slice(i) %>%
        mutate(prop = news/(news + old))
    mean(df$prop)
    
}

booted <- boot(data = lastfm, 
               statistic = theta, 
               R = 2000)

ci = tidy(booted, 
          conf.level = .95,
          conf.method = "bca",
          conf.int = TRUE)

glimpse(ci)
```

```{r}
ci %>%
    ggplot(aes(
        x = "",
        y = statistic,
        ymin = conf.low,
        ymax = conf.high
    )) +
    geom_pointrange() +
    geom_point(size = 3) + 
    labs(x = "", 
         y = "Proporção de novos artistas")
```


## 2. Para os usuários que gostam de música muito pop (mediana_pop > 5), qual a correlação entre a popularidade mediana dos artistas escutado e a proporção dos artistas escutados que eram novos. 

```{r}
theta_2 <- function(d, i) {
    df = d %>%
        slice(i) %>%
        filter(mediana_pop > 5) %>%
        mutate(prop = news/(news+old))
    
    cor(df$prop, df$mediana_pop)
    
}

booted_2 <- boot(data = lastfm, 
               statistic = theta_2, 
               R = 2000)

ci_2 = tidy(booted_2, 
          conf.level = .95,
          conf.method = "bca",
          conf.int = TRUE)

glimpse(ci_2)

```


```{r}
ci_2 %>%
    ggplot(aes(
        x = "",
        y = statistic,
        ymin = conf.low,
        ymax = conf.high
    )) +
    geom_pointrange() +
    geom_point(size = 3) + 
    labs(x = "", 
         y = "Correlação entre a popularidade mediana dos artistas e a proporção dos artistas novos")
```








